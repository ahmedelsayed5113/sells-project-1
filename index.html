<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PropFinder ‚Äî Sales Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0f; --surface: #12121a; --surface2: #1a1a26; --border: #2a2a3a;
    --accent: #7c6dff; --accent2: #ff6d9e; --accent3: #6dffcb;
    --text: #e8e8f0; --muted: #6b6b80; --card: #16161f;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:'DM Sans',sans-serif; min-height:100vh; overflow-x:hidden; }

  /* ‚îÄ‚îÄ DESKTOP GRID ‚îÄ‚îÄ */
  .app { display:grid; grid-template-columns:340px 1fr; grid-template-rows:auto 1fr; min-height:100vh; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    grid-column:1/-1; display:flex; align-items:center; justify-content:space-between;
    padding:20px 32px; border-bottom:1px solid var(--border);
    background:rgba(10,10,15,0.9); backdrop-filter:blur(20px);
    position:sticky; top:0; z-index:50; gap:16px;
  }
  .logo { display:flex; align-items:center; gap:12px; flex-shrink:0; }
  .logo-icon { width:36px; height:36px; background:linear-gradient(135deg,var(--accent),var(--accent2)); border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:18px; }
  .logo-text { font-family:'Syne',sans-serif; font-weight:800; font-size:20px; }
  .logo-text span { color:var(--accent); }
  .header-stats { display:flex; gap:32px; }
  .stat { text-align:center; }
  .stat-value { font-family:'Syne',sans-serif; font-weight:700; font-size:20px; color:var(--accent3); }
  .stat-label { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.8px; }
  .header-search {
    display:flex; align-items:center; gap:10px; background:var(--surface2);
    border:1px solid var(--border); border-radius:12px; padding:10px 16px; width:280px;
  }
  .header-search:focus-within { border-color:var(--accent); }
  .header-search input { background:none; border:none; outline:none; color:var(--text); font-family:'DM Sans',sans-serif; font-size:14px; width:100%; }
  .header-search input::placeholder { color:var(--muted); }
  .search-clear { background:none; border:none; cursor:pointer; color:var(--muted); font-size:18px; opacity:0; transition:opacity .2s; padding:0; touch-action:manipulation; }
  .search-clear.visible { opacity:1; }

  /* ‚îÄ‚îÄ HAMBURGER ‚îÄ‚îÄ */
  .hamburger-btn {
    display:none; align-items:center; justify-content:center; flex-direction:column; gap:5px;
    width:44px; height:44px; background:var(--surface2); border:1px solid var(--border);
    border-radius:10px; cursor:pointer; flex-shrink:0; position:relative;
    touch-action:manipulation; -webkit-tap-highlight-color:transparent;
  }
  .hamburger-btn span { display:block; width:18px; height:2px; background:var(--text); border-radius:2px; transition:all .3s; }
  .hamburger-btn.open span:nth-child(1) { transform:rotate(45deg) translate(5px,5px); }
  .hamburger-btn.open span:nth-child(2) { opacity:0; }
  .hamburger-btn.open span:nth-child(3) { transform:rotate(-45deg) translate(5px,-5px); }
  .filter-badge {
    position:absolute; top:-5px; right:-5px;
    background:var(--accent); color:#fff; font-size:10px; font-weight:700;
    border-radius:10px; padding:1px 5px; display:none;
  }
  .filter-badge.on { display:block; }

  /* ‚îÄ‚îÄ MOBILE STATS ‚îÄ‚îÄ */
  .mobile-stats {
    display:none; grid-column:1/-1;
    background:var(--surface2); border-bottom:1px solid var(--border);
  }
  .mobile-stats-inner { display:flex; }
  .mobile-stats .stat { flex:1; padding:10px 12px; border-right:1px solid var(--border); text-align:center; }
  .mobile-stats .stat:last-child { border-right:none; }
  .mobile-stats .stat-value { font-size:14px; }
  .mobile-stats .stat-label { font-size:9px; }

  /* ‚îÄ‚îÄ MOBILE SEARCH ‚îÄ‚îÄ */
  .mobile-search {
    display:none; grid-column:1/-1;
    align-items:center; gap:10px; padding:10px 16px;
    background:var(--surface2); border-bottom:1px solid var(--border);
  }
  .mobile-search input { background:none; border:none; outline:none; color:var(--text); font-family:'DM Sans',sans-serif; font-size:14px; flex:1; }
  .mobile-search input::placeholder { color:var(--muted); }

  /* ‚îÄ‚îÄ OVERLAY ‚îÄ‚îÄ */
  .overlay {
    display:none; position:fixed; inset:0;
    background:rgba(0,0,0,0.5); z-index:98;
    opacity:0; pointer-events:none; transition:opacity .3s;
  }
  .overlay.on { opacity:1; pointer-events:all; }

  /* ‚îÄ‚îÄ SIDEBAR (DESKTOP) ‚îÄ‚îÄ */
  .sidebar {
    border-right:1px solid var(--border); padding:20px;
    overflow-y:auto; max-height:calc(100vh - 77px);
    position:sticky; top:77px;
    scrollbar-width:thin; scrollbar-color:var(--border) transparent;
  }

  /* close row hidden on desktop */
  .sidebar-top {
    display:none; justify-content:space-between; align-items:center;
    padding-bottom:14px; margin-bottom:14px; border-bottom:1px solid var(--border);
    flex-shrink:0;
  }
  .sidebar-top-title { font-family:'Syne',sans-serif; font-weight:700; font-size:15px; }
  .close-btn {
    background:var(--surface2); border:1px solid var(--border); border-radius:8px;
    color:var(--text); font-size:22px; line-height:1; cursor:pointer;
    width:38px; height:38px; display:flex; align-items:center; justify-content:center;
    touch-action:manipulation; -webkit-tap-highlight-color:transparent;
  }

  .sidebar-title { font-family:'Syne',sans-serif; font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1.5px; color:var(--muted); margin-bottom:16px; display:flex; align-items:center; gap:8px; }
  .sidebar-title::after { content:''; flex:1; height:1px; background:var(--border); }
  .filter-section { margin-bottom:20px; }
  .filter-label { font-size:11px; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:.8px; margin-bottom:8px; }

  /* ‚îÄ‚îÄ WIDGETS ‚îÄ‚îÄ */
  .price-widget, .area-widget { background:var(--surface2); border:1px solid var(--border); border-radius:14px; padding:14px; }
  .presets { display:flex; flex-wrap:wrap; gap:4px; margin-bottom:12px; }
  .chip {
    padding:4px 10px; border-radius:16px; border:1px solid var(--border);
    background:transparent; color:var(--muted); font-size:11px; cursor:pointer;
    font-family:'DM Sans',sans-serif; white-space:nowrap;
    touch-action:manipulation; -webkit-tap-highlight-color:transparent; transition:all .15s;
  }
  .chip.on { border-color:var(--accent); color:var(--accent); background:rgba(124,109,255,.12); }

  .range-row { display:grid; grid-template-columns:1fr auto 1fr; gap:6px; align-items:center; margin-bottom:12px; }
  .range-sep { color:var(--muted); text-align:center; }
  .rng-wrap { position:relative; }
  .rng-wrap label { position:absolute; top:-7px; left:8px; font-size:9px; color:var(--muted); background:var(--surface2); padding:0 4px; text-transform:uppercase; z-index:1; }
  .rng-wrap input[type=number] { width:100%; background:var(--bg); border:1px solid var(--border); border-radius:8px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:12px; padding:8px 6px; outline:none; text-align:center; }
  .rng-wrap input[type=number]:focus { border-color:var(--accent); }
  .hint { font-size:10px; color:var(--muted); text-align:center; margin-top:2px; }

  .slider-wrap { position:relative; height:34px; margin-top:6px; }
  .track-bg { position:absolute; top:50%; transform:translateY(-50%); height:4px; background:var(--border); border-radius:2px; width:100%; }
  .track-fill { position:absolute; height:4px; border-radius:2px; top:0; }
  .slider-wrap input[type=range] { position:absolute; width:100%; height:4px; background:transparent; pointer-events:none; -webkit-appearance:none; top:50%; transform:translateY(-50%); }
  .slider-wrap input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:26px; height:26px; border-radius:50%; background:var(--accent); border:3px solid var(--bg); cursor:pointer; pointer-events:all; box-shadow:0 0 0 2px var(--accent); }
  .scale-markers { display:flex; justify-content:space-between; margin-top:4px; }
  .scale-marker { font-size:9px; color:var(--muted); }

  .single-rng { background:var(--surface2); border:1px solid var(--border); border-radius:14px; padding:14px; }
  .single-rng-top { display:flex; justify-content:space-between; margin-bottom:8px; }
  .rng-val { font-family:'Syne',sans-serif; font-size:14px; font-weight:600; }
  .single-rng input[type=range] { width:100%; accent-color:var(--accent2); cursor:pointer; }

  .pill-group { display:flex; flex-wrap:wrap; gap:5px; }
  .pill {
    padding:6px 12px; border-radius:20px; border:1px solid var(--border);
    background:var(--surface2); color:var(--muted); font-size:12px; font-weight:500;
    cursor:pointer; user-select:none; white-space:nowrap;
    min-height:36px; display:flex; align-items:center;
    touch-action:manipulation; -webkit-tap-highlight-color:transparent; transition:all .15s;
  }
  .pill.on { background:var(--accent); border-color:var(--accent); color:#fff; }
  .pill.on-green { background:var(--accent3); border-color:var(--accent3); color:#000; }

  .styled-select {
    width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:10px;
    color:var(--text); font-family:'DM Sans',sans-serif; font-size:13px;
    padding:10px 32px 10px 12px; outline:none; min-height:44px;
    -webkit-appearance:none;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b6b80' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat:no-repeat; background-position:right 12px center;
  }

  .num-inputs { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .num-wrap { position:relative; }
  .num-wrap label { position:absolute; top:-8px; left:10px; font-size:10px; color:var(--muted); background:var(--bg); padding:0 4px; text-transform:uppercase; }
  .num-wrap input { width:100%; background:var(--surface2); border:1px solid var(--border); border-radius:10px; color:var(--text); font-family:'DM Sans',sans-serif; font-size:13px; padding:10px 12px; outline:none; min-height:44px; }
  .num-wrap input:focus { border-color:var(--accent); }

  .toggle-row { display:flex; align-items:center; justify-content:space-between; padding:8px 0; min-height:44px; }
  .toggle-label { font-size:13px; }
  .toggle { position:relative; width:44px; height:26px; flex-shrink:0; }
  .toggle input { opacity:0; width:0; height:0; }
  .tog-slider { position:absolute; inset:0; background:var(--surface2); border:1px solid var(--border); border-radius:26px; cursor:pointer; transition:all .2s; touch-action:manipulation; }
  .tog-slider::after { content:''; position:absolute; left:3px; top:50%; transform:translateY(-50%); width:18px; height:18px; background:var(--muted); border-radius:50%; transition:all .2s; }
  .toggle input:checked + .tog-slider { background:var(--accent); border-color:var(--accent); }
  .toggle input:checked + .tog-slider::after { left:23px; background:#fff; }

  .btn-reset { width:100%; padding:12px; background:transparent; border:1px solid var(--border); border-radius:10px; color:var(--muted); font-family:'DM Sans',sans-serif; font-size:13px; cursor:pointer; min-height:44px; touch-action:manipulation; -webkit-tap-highlight-color:transparent; transition:all .2s; margin-top:4px; }
  .btn-reset:active { border-color:var(--accent2); color:var(--accent2); }

  /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
  .main { padding:24px; overflow-y:auto; max-height:calc(100vh - 77px); }
  .results-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; flex-wrap:wrap; gap:10px; }
  .results-count { font-family:'Syne',sans-serif; font-size:22px; font-weight:700; }
  .results-count span { color:var(--accent); }
  .sort-row { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
  .sort-btn { padding:7px 12px; background:var(--surface2); border:1px solid var(--border); border-radius:8px; color:var(--muted); font-size:12px; cursor:pointer; font-family:'DM Sans',sans-serif; min-height:36px; touch-action:manipulation; -webkit-tap-highlight-color:transparent; transition:all .2s; }
  .sort-btn.on { border-color:var(--accent); color:var(--accent); }

  .active-tags { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:14px; }
  .tag { display:flex; align-items:center; gap:6px; background:rgba(124,109,255,.15); border:1px solid rgba(124,109,255,.3); border-radius:20px; padding:4px 10px 4px 12px; font-size:12px; color:var(--accent); }
  .tag button { background:none; border:none; cursor:pointer; color:var(--accent); font-size:16px; line-height:1; padding:0; min-width:24px; min-height:24px; display:flex; align-items:center; justify-content:center; touch-action:manipulation; }

  .cards-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(290px,1fr)); gap:14px; }
  .unit-card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:18px; position:relative; overflow:hidden; animation:cardIn .3s ease both; }
  @keyframes cardIn { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
  .card-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px; }
  .compound-name { font-family:'Syne',sans-serif; font-size:14px; font-weight:700; flex:1; }
  .type-badge { padding:3px 9px; border-radius:20px; font-size:11px; background:rgba(109,255,203,.12); color:var(--accent3); border:1px solid rgba(109,255,203,.2); white-space:nowrap; margin-left:8px; }
  .card-meta { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:14px; }
  .meta-chip { display:flex; align-items:center; gap:4px; font-size:11px; color:var(--muted); background:var(--surface2); border-radius:6px; padding:3px 7px; }
  .meta-chip strong { color:var(--text); font-weight:500; }
  .card-price { border-top:1px solid var(--border); padding-top:12px; display:flex; justify-content:space-between; align-items:flex-end; }
  .price-main { font-family:'Syne',sans-serif; font-size:17px; font-weight:700; }
  .price-main small { font-size:11px; color:var(--muted); font-family:'DM Sans',sans-serif; display:block; }
  .price-psm { font-size:12px; color:var(--accent); text-align:right; }
  .price-psm small { color:var(--muted); font-size:10px; display:block; }
  .card-footer { display:flex; gap:6px; margin-top:10px; }
  .card-detail { flex:1; font-size:10px; color:var(--muted); background:var(--surface2); border-radius:6px; padding:5px 4px; text-align:center; }
  .card-detail strong { display:block; color:var(--text); font-size:11px; margin-bottom:1px; }
  .empty-state { grid-column:1/-1; text-align:center; padding:80px 20px; color:var(--muted); }
  .empty-state h3 { font-family:'Syne',sans-serif; font-size:20px; color:var(--text); margin-bottom:8px; }
  .loading { grid-column:1/-1; text-align:center; padding:60px; color:var(--muted); }
  .spinner { width:32px; height:32px; border:3px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin .8s linear infinite; margin:0 auto 16px; }
  @keyframes spin { to{transform:rotate(360deg)} }
  ::-webkit-scrollbar { width:6px; }
  ::-webkit-scrollbar-track { background:transparent; }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MOBILE ‚â§ 768px
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  @media (max-width:768px) {
    .app { grid-template-columns:1fr; grid-template-rows:auto auto auto 1fr; }
    header { padding:12px 16px; }
    .logo-text { font-size:16px; }
    .logo-icon { width:30px; height:30px; font-size:15px; }
    .header-stats { display:none; }
    .header-search { display:none; }
    .hamburger-btn { display:flex; }
    .mobile-stats { display:block; }
    .mobile-search { display:flex; }
    .overlay { display:block; }

    /* SIDEBAR = FIXED DRAWER */
    .sidebar {
      position:fixed !important;
      top:0; left:0;
      width:min(320px, 90vw);
      height:100vh;
      z-index:99;
      background:var(--bg);
      border-right:1px solid var(--border);
      /* flex column: top bar fixed, content scrolls */
      display:flex !important;
      flex-direction:column;
      padding:16px;
      overflow:hidden; /* no scroll on outer */
      transform:translateX(-100%);
      transition:transform .3s cubic-bezier(.4,0,.2,1);
      max-height:100vh;
    }
    .sidebar.open { transform:translateX(0); }

    /* scrollable inner */
    .sidebar-inner {
      flex:1;
      overflow-y:auto;
      overflow-x:hidden;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:thin;
      padding-bottom:30px;
    }

    .sidebar-top { display:flex; }

    .main { padding:14px; max-height:none; overflow-y:visible; }
    .results-header { flex-direction:column; align-items:flex-start; gap:8px; }
    .results-count { font-size:18px; }
    .sort-row { width:100%; overflow-x:auto; flex-wrap:nowrap; -webkit-overflow-scrolling:touch; scrollbar-width:none; padding-bottom:2px; }
    .sort-row::-webkit-scrollbar { display:none; }
    .sort-btn { white-space:nowrap; flex-shrink:0; }
    .cards-grid { grid-template-columns:1fr; gap:10px; }
    .pill { min-height:40px; padding:8px 14px; font-size:13px; }
    .chip { min-height:32px; padding:6px 11px; font-size:12px; }
    .slider-wrap input[type=range]::-webkit-slider-thumb { width:30px; height:30px; }
  }
  @media (min-width:480px) and (max-width:768px) {
    .cards-grid { grid-template-columns:repeat(2,1fr); }
  }
</style>
</head>
<body>

<!-- Overlay (mobile) - clicking it closes sidebar -->
<div class="overlay" id="overlay"></div>

<div class="app">

  <!-- HEADER -->
  <header>
    <div class="logo">
      <div class="logo-icon">üèôÔ∏è</div>
      <div class="logo-text">Prop<span>Finder</span></div>
    </div>
    <div class="header-stats">
      <div class="stat"><div class="stat-value" id="totalCount">‚Äî</div><div class="stat-label">Total Units</div></div>
      <div class="stat"><div class="stat-value" id="filteredCount">‚Äî</div><div class="stat-label">Matching</div></div>
      <div class="stat"><div class="stat-value" id="avgPrice">‚Äî</div><div class="stat-label">Avg Price</div></div>
      <div class="stat"><div class="stat-value" id="compoundCount">‚Äî</div><div class="stat-label">Compounds</div></div>
    </div>
    <div class="header-search">
      <span>üîç</span>
      <input type="text" id="searchInput" placeholder="Compound, developer, area..." autocomplete="off">
      <button class="search-clear" id="searchClear">√ó</button>
    </div>
    <button class="hamburger-btn" id="hamburgerBtn">
      <span></span><span></span><span></span>
      <div class="filter-badge" id="filterBadge">0</div>
    </button>
  </header>

  <!-- MOBILE STATS -->
  <div class="mobile-stats">
    <div class="mobile-stats-inner">
      <div class="stat"><div class="stat-value" id="totalCountM">‚Äî</div><div class="stat-label">Total</div></div>
      <div class="stat"><div class="stat-value" id="filteredCountM">‚Äî</div><div class="stat-label">Matching</div></div>
      <div class="stat"><div class="stat-value" id="avgPriceM">‚Äî</div><div class="stat-label">Avg Price</div></div>
      <div class="stat"><div class="stat-value" id="compoundCountM">‚Äî</div><div class="stat-label">Compounds</div></div>
    </div>
  </div>

  <!-- MOBILE SEARCH -->
  <div class="mobile-search">
    <span>üîç</span>
    <input type="text" id="searchInputM" placeholder="Compound, developer, area..." autocomplete="off">
    <button class="search-clear" id="searchClearM" style="opacity:0">√ó</button>
  </div>

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">

    <!-- Top bar (mobile only) -->
    <div class="sidebar-top">
      <div class="sidebar-top-title">Filters</div>
      <button class="close-btn" id="closeBtn">√ó</button>
    </div>

    <!-- All filter content scrolls inside this div on mobile -->
    <div class="sidebar-inner">

      <div class="sidebar-title">Filters</div>

      <div class="filter-section">
        <div class="filter-label">City</div>
        <div class="pill-group" id="cityFilter"></div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Unit Type</div>
        <div class="pill-group" id="unitTypeFilter"></div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Bedrooms</div>
        <div class="pill-group" id="bedroomsFilter">
          <div class="pill on-green" data-bed="any">Any</div>
          <div class="pill" data-bed="1">1 BR</div>
          <div class="pill" data-bed="2">2 BR</div>
          <div class="pill" data-bed="3">3 BR</div>
          <div class="pill" data-bed="4">4 BR</div>
          <div class="pill" data-bed="5">5+ BR</div>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Total Price <span style="color:var(--accent3);font-size:9px">EGP</span></div>
        <div class="price-widget">
          <div class="presets" id="pricePresets">
            <button class="chip" data-pmin="0" data-pmax="5000000" data-label="Under 5M">Under 5M</button>
            <button class="chip" data-pmin="5000000" data-pmax="10000000" data-label="5M‚Äì10M">5M‚Äì10M</button>
            <button class="chip" data-pmin="10000000" data-pmax="20000000" data-label="10M‚Äì20M">10M‚Äì20M</button>
            <button class="chip" data-pmin="20000000" data-pmax="50000000" data-label="20M‚Äì50M">20M‚Äì50M</button>
            <button class="chip" data-pmin="50000000" data-pmax="100000000" data-label="50M‚Äì100M">50M‚Äì100M</button>
            <button class="chip" data-pmin="100000000" data-pmax="500000000" data-label="100M‚Äì500M">100M‚Äì500M</button>
            <button class="chip" data-pmin="500000000" data-pmax="999999999999" data-label="500M+">500M+</button>
          </div>
          <div class="range-row">
            <div class="rng-wrap"><label>Min</label><input type="number" id="priceMinIn" placeholder="0" min="0" step="500000"><div class="hint" id="priceMinHint">‚Äî</div></div>
            <div class="range-sep">‚Üí</div>
            <div class="rng-wrap"><label>Max</label><input type="number" id="priceMaxIn" placeholder="‚àû" min="0" step="500000"><div class="hint" id="priceMaxHint">‚Äî</div></div>
          </div>
          <div class="slider-wrap">
            <div class="track-bg"><div class="track-fill" id="priceFill" style="background:linear-gradient(90deg,var(--accent),var(--accent2))"></div></div>
            <input type="range" id="priceSMin" min="0" max="1000" value="0">
            <input type="range" id="priceSMax" min="0" max="1000" value="1000">
          </div>
          <div class="scale-markers">
            <span class="scale-marker">1M</span><span class="scale-marker">5M</span>
            <span class="scale-marker">20M</span><span class="scale-marker">100M</span><span class="scale-marker">500M+</span>
          </div>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Built-Up Area <span style="color:var(--accent3);font-size:9px">m¬≤</span></div>
        <div class="area-widget">
          <div class="presets">
            <button class="chip area-chip" data-min="0" data-max="80">Under 80</button>
            <button class="chip area-chip" data-min="80" data-max="150">80‚Äì150</button>
            <button class="chip area-chip" data-min="150" data-max="250">150‚Äì250</button>
            <button class="chip area-chip" data-min="250" data-max="9999">250+</button>
          </div>
          <div class="range-row">
            <div class="rng-wrap"><label>Min m¬≤</label><input type="number" id="areaMinIn" placeholder="0" min="0" step="5"></div>
            <div class="range-sep">‚Üí</div>
            <div class="rng-wrap"><label>Max m¬≤</label><input type="number" id="areaMaxIn" placeholder="‚àû" min="0" step="5"></div>
          </div>
          <div class="slider-wrap">
            <div class="track-bg"><div class="track-fill" id="areaFill" style="background:linear-gradient(90deg,var(--accent3),var(--accent))"></div></div>
            <input type="range" id="areaSMin" min="0" max="1000" value="0">
            <input type="range" id="areaSMax" min="0" max="1000" value="1000">
          </div>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Price / m¬≤ <span style="color:var(--accent3);font-size:9px">EGP</span></div>
        <div class="area-widget">
          <div class="presets">
            <button class="chip psm-chip" data-min="0" data-max="50000">Under 50K</button>
            <button class="chip psm-chip" data-min="50000" data-max="100000">50K‚Äì100K</button>
            <button class="chip psm-chip" data-min="100000" data-max="200000">100K‚Äì200K</button>
            <button class="chip psm-chip" data-min="200000" data-max="9999999">200K+</button>
          </div>
          <div class="range-row">
            <div class="rng-wrap"><label>Min/m¬≤</label><input type="number" id="psmMinIn" placeholder="0" min="0" step="5000"></div>
            <div class="range-sep">‚Üí</div>
            <div class="rng-wrap"><label>Max/m¬≤</label><input type="number" id="psmMaxIn" placeholder="‚àû" min="0" step="5000"></div>
          </div>
          <div class="slider-wrap">
            <div class="track-bg"><div class="track-fill" id="psmFill" style="background:linear-gradient(90deg,var(--accent2),var(--accent))"></div></div>
            <input type="range" id="psmSMin" min="0" max="1000" value="0">
            <input type="range" id="psmSMax" min="0" max="1000" value="1000">
          </div>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Delivery (months)</div>
        <div class="presets" id="deliveryPresets" style="margin-bottom:8px">
          <button class="chip del-chip" data-from="0" data-to="6">Ready</button>
          <button class="chip del-chip" data-from="0" data-to="12">1yr</button>
          <button class="chip del-chip" data-from="0" data-to="24">2yr</button>
          <button class="chip del-chip" data-from="0" data-to="36">3yr</button>
        </div>
        <div class="num-inputs">
          <div class="num-wrap"><label>From</label><input type="number" id="deliveryFrom" placeholder="e.g. 6"></div>
          <div class="num-wrap"><label>To</label><input type="number" id="deliveryTo" placeholder="e.g. 24"></div>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Developer</div>
        <select class="styled-select" id="developerFilter"><option value="">All Developers</option></select>
      </div>

      <div class="filter-section">
        <div class="filter-label">Finishing Type</div>
        <div class="pill-group" id="finishingFilter"></div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Min Cash Discount</div>
        <div class="single-rng">
          <div class="single-rng-top">
            <span class="rng-val" id="discountVal" style="color:var(--accent2)">0%</span>
            <span style="font-size:11px;color:var(--muted)">minimum</span>
          </div>
          <input type="range" id="discountSlider" min="0" max="40" value="0">
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-label">Options</div>
        <div class="toggle-row">
          <span class="toggle-label">Free Club Fees</span>
          <label class="toggle"><input type="checkbox" id="freeClub"><span class="tog-slider"></span></label>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">Free Parking</span>
          <label class="toggle"><input type="checkbox" id="freeParking"><span class="tog-slider"></span></label>
        </div>
        <div class="toggle-row">
          <span class="toggle-label">Hide Sold Units</span>
          <label class="toggle"><input type="checkbox" id="hideSold"><span class="tog-slider"></span></label>
        </div>
      </div>

      <button class="btn-reset" id="resetBtn">‚Ü∫ Reset All Filters</button>

    </div><!-- end sidebar-inner -->
  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="results-header">
      <div class="results-count"><span id="resultNum">‚Äî</span> units found</div>
      <div class="sort-row">
        <span style="font-size:12px;color:var(--muted);white-space:nowrap;flex-shrink:0">Sort:</span>
        <button class="sort-btn on" data-sort="price_asc">Price ‚Üë</button>
        <button class="sort-btn" data-sort="price_desc">Price ‚Üì</button>
        <button class="sort-btn" data-sort="area_desc">Area ‚Üì</button>
        <button class="sort-btn" data-sort="psm_asc">PSM ‚Üë</button>
        <button class="sort-btn" data-sort="discount_desc">Discount ‚Üì</button>
        <button class="sort-btn" data-sort="delivery_asc">Delivery ‚Üë</button>
      </div>
    </div>
    <div class="active-tags" id="activeTags"></div>
    <div class="cards-grid" id="cardsGrid">
      <div class="loading"><div class="spinner"></div>Loading units data...</div>
    </div>
  </main>

</div>

<script>
const PLOG_MIN=6,PLOG_MAX=8.699,AREA_MAX=1000,PSM_MIN=4,PSM_MAX=6.3;
let allData=[],filteredData=[],sortMode='price_asc',batchEnd=50;
const rs={pMin:null,pMax:null,aMin:null,aMax:null,sMin:null,sMax:null};
const af={cities:new Set(),types:new Set(),beds:'any',fin:new Set()};

const g=id=>document.getElementById(id);
const s2p=v=>Math.round(Math.pow(10,PLOG_MIN+(v/1000)*(PLOG_MAX-PLOG_MIN)));
const p2s=p=>!p||p<=0?0:Math.round(Math.max(0,Math.min(1000,((Math.log10(p)-PLOG_MIN)/(PLOG_MAX-PLOG_MIN))*1000)));
const s2psm=v=>Math.round(Math.pow(10,PSM_MIN+(v/1000)*(PSM_MAX-PSM_MIN)));
const psm2s=p=>!p||p<=0?0:Math.round(Math.max(0,Math.min(1000,((Math.log10(p)-PSM_MIN)/(PSM_MAX-PSM_MIN))*1000)));
const s2a=v=>Math.round((v/1000)*AREA_MAX);
const a2s=a=>Math.round((a/AREA_MAX)*1000);
const fmt=n=>n?.toLocaleString('en-US')?? '0';
function fmtM(n){if(!n)return '0';if(n>=1e9)return(n/1e9).toFixed(2).replace(/\.?0+$/,'')+' B';if(n>=1e6)return(n/1e6).toFixed(2).replace(/\.?0+$/,'')+' M';if(n>=1e3)return(n/1e3).toFixed(0)+'K';return fmt(Math.round(n));}

function syncFill(fid,n,x){const f=g(fid),a=g(n),b=g(x);if(!f||!a||!b)return;f.style.left=(+a.value/10)+'%';f.style.width=((+b.value-+a.value)/10)+'%';}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
function openSidebar(){g('sidebar').classList.add('open');g('overlay').classList.add('on');g('hamburgerBtn').classList.add('open');document.body.style.overflow='hidden';}
function closeSidebar(){g('sidebar').classList.remove('open');g('overlay').classList.remove('on');g('hamburgerBtn').classList.remove('open');document.body.style.overflow='';}

/* ‚îÄ‚îÄ PRICE ‚îÄ‚îÄ */
function onPriceSlide(){
  const a=g('priceSMin'),b=g('priceSMax');
  if(+a.value>+b.value)a.value=b.value;
  const v1=s2p(+a.value),v2=s2p(+b.value);
  rs.pMin=+a.value===0?null:v1; rs.pMax=+b.value===1000?null:v2;
  g('priceMinIn').value=rs.pMin||''; g('priceMaxIn').value=rs.pMax||'';
  g('priceMinHint').textContent=rs.pMin?fmtM(v1):'‚Äî'; g('priceMaxHint').textContent=rs.pMax?fmtM(v2):'‚Äî';
  clearChips('pricePresets'); syncFill('priceFill','priceSMin','priceSMax'); applyFilters();
}
function onPriceInput(){
  const a=parseFloat(g('priceMinIn').value),b=parseFloat(g('priceMaxIn').value);
  rs.pMin=isNaN(a)||a<=0?null:a; rs.pMax=isNaN(b)||b<=0?null:b;
  g('priceMinHint').textContent=rs.pMin?fmtM(rs.pMin):'‚Äî'; g('priceMaxHint').textContent=rs.pMax?fmtM(rs.pMax):'‚Äî';
  g('priceSMin').value=rs.pMin?p2s(rs.pMin):0; g('priceSMax').value=rs.pMax?p2s(rs.pMax):1000;
  clearChips('pricePresets'); syncFill('priceFill','priceSMin','priceSMax'); applyFilters();
}
function setPricePreset(mn,mx,lbl){
  rs.pMin=mn>0?mn:null; rs.pMax=mx>=999999999999?null:mx;
  g('priceMinIn').value=mn>0?mn:''; g('priceMaxIn').value=mx>=999999999999?'':mx;
  g('priceMinHint').textContent=mn>0?fmtM(mn):'‚Äî'; g('priceMaxHint').textContent=(mx&&mx<999999999999)?fmtM(mx):'‚Äî';
  g('priceSMin').value=mn>0?p2s(mn):0; g('priceSMax').value=(mx&&mx<999999999999)?p2s(mx):1000;
  syncFill('priceFill','priceSMin','priceSMax'); hlChip('pricePresets',lbl); applyFilters();
}

/* ‚îÄ‚îÄ AREA ‚îÄ‚îÄ */
function onAreaSlide(){
  const a=g('areaSMin'),b=g('areaSMax');
  if(+a.value>+b.value)a.value=b.value;
  rs.aMin=+a.value===0?null:s2a(+a.value); rs.aMax=+b.value===1000?null:s2a(+b.value);
  g('areaMinIn').value=rs.aMin||''; g('areaMaxIn').value=rs.aMax||'';
  syncFill('areaFill','areaSMin','areaSMax'); applyFilters();
}
function onAreaInput(){
  const a=parseFloat(g('areaMinIn').value),b=parseFloat(g('areaMaxIn').value);
  rs.aMin=isNaN(a)||a<=0?null:a; rs.aMax=isNaN(b)||b<=0?null:b;
  g('areaSMin').value=rs.aMin?a2s(rs.aMin):0; g('areaSMax').value=rs.aMax?a2s(rs.aMax):1000;
  syncFill('areaFill','areaSMin','areaSMax'); applyFilters();
}
function setAreaPreset(mn,mx){
  rs.aMin=mn>0?mn:null; rs.aMax=mx>=9999?null:mx;
  g('areaMinIn').value=mn>0?mn:''; g('areaMaxIn').value=mx>=9999?'':mx;
  g('areaSMin').value=mn>0?a2s(mn):0; g('areaSMax').value=(mx&&mx<9999)?a2s(mx):1000;
  syncFill('areaFill','areaSMin','areaSMax'); applyFilters();
}

/* ‚îÄ‚îÄ PSM ‚îÄ‚îÄ */
function onPsmSlide(){
  const a=g('psmSMin'),b=g('psmSMax');
  if(+a.value>+b.value)a.value=b.value;
  rs.sMin=+a.value===0?null:s2psm(+a.value); rs.sMax=+b.value===1000?null:s2psm(+b.value);
  g('psmMinIn').value=rs.sMin||''; g('psmMaxIn').value=rs.sMax||'';
  syncFill('psmFill','psmSMin','psmSMax'); applyFilters();
}
function onPsmInput(){
  const a=parseFloat(g('psmMinIn').value),b=parseFloat(g('psmMaxIn').value);
  rs.sMin=isNaN(a)||a<=0?null:a; rs.sMax=isNaN(b)||b<=0?null:b;
  g('psmSMin').value=rs.sMin?psm2s(rs.sMin):0; g('psmSMax').value=rs.sMax?psm2s(rs.sMax):1000;
  syncFill('psmFill','psmSMin','psmSMax'); applyFilters();
}
function setPsmPreset(mn,mx){
  rs.sMin=mn>0?mn:null; rs.sMax=mx>=9999999?null:mx;
  g('psmMinIn').value=mn>0?mn:''; g('psmMaxIn').value=mx>=9999999?'':mx;
  g('psmSMin').value=mn>0?psm2s(mn):0; g('psmSMax').value=(mx&&mx<9999999)?psm2s(mx):1000;
  syncFill('psmFill','psmSMin','psmSMax'); applyFilters();
}

function hlChip(cid,lbl){document.querySelectorAll('#'+cid+' .chip').forEach(c=>c.classList.toggle('on',c.textContent.trim()===lbl));}
function clearChips(cid){document.querySelectorAll('#'+cid+' .chip').forEach(c=>c.classList.remove('on'));}
function clearDelChips(){document.querySelectorAll('.del-chip').forEach(c=>c.classList.remove('on'));}

function updateBadge(){
  let n=af.cities.size+af.types.size+af.fin.size;
  if(af.beds!=='any')n++;if(rs.pMin||rs.pMax)n++;if(rs.aMin||rs.aMax)n++;if(rs.sMin||rs.sMax)n++;
  if(+g('discountSlider').value>0)n++;if(g('freeClub').checked)n++;if(g('freeParking').checked)n++;
  if(g('hideSold').checked)n++;if(g('developerFilter').value)n++;if(g('deliveryFrom').value||g('deliveryTo').value)n++;
  const b=g('filterBadge');b.textContent=n;n>0?b.classList.add('on'):b.classList.remove('on');
}

async function loadData(){
  g('cardsGrid').innerHTML='<div class="loading"><div class="spinner"></div>Loading units data...</div>';
  try{
    const r=await fetch('/api/units');if(!r.ok)throw new Error('HTTP '+r.status);
    const d=await r.json();if(d.error)throw new Error(d.error);allData=d;
  }catch(e){
    g('cardsGrid').innerHTML=`<div class="empty-state"><h3>‚ö†Ô∏è Failed to load</h3><p>${e.message}</p><button class="btn-reset" id="retryBtn" style="width:auto;margin-top:16px">üîÑ Retry</button></div>`;
    g('retryBtn')?.addEventListener('click',loadData);return;
  }
  initPage();
}

function initPage(){
  if(!allData.length){g('cardsGrid').innerHTML='<div class="empty-state"><h3>No data</h3></div>';return;}
  buildPills('cityFilter',[...new Set(allData.map(d=>d.city_name))].sort(),'city');
  buildPills('unitTypeFilter',[...new Set(allData.map(d=>d.unit_type))].sort(),'type');
  buildPills('finishingFilter',[...new Set(allData.map(d=>d.finishing_type).filter(Boolean))].sort(),'fin');
  const ds=g('developerFilter');
  [...new Set(allData.map(d=>d.developer_name))].sort().forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;ds.appendChild(o);});
  const tot=fmt(allData.length),comp=new Set(allData.map(d=>d.compound_name)).size;
  ['totalCount','totalCountM'].forEach(id=>g(id).textContent=tot);
  ['compoundCount','compoundCountM'].forEach(id=>g(id).textContent=comp);
  syncFill('priceFill','priceSMin','priceSMax');syncFill('areaFill','areaSMin','areaSMax');syncFill('psmFill','psmSMin','psmSMax');
  applyFilters();
}

function buildPills(cid,vals,type){
  const el=g(cid);
  const any=document.createElement('div');any.className='pill on-green';any.textContent='All';
  any.addEventListener('click',()=>{
    const st=type==='city'?af.cities:type==='type'?af.types:af.fin;
    st.clear();el.querySelectorAll('.pill').forEach(p=>p.classList.remove('on'));
    any.classList.add('on-green');applyFilters();
  });
  el.appendChild(any);
  vals.forEach(v=>{
    const p=document.createElement('div');p.className='pill';p.textContent=v;
    p.addEventListener('click',()=>{
      any.classList.remove('on-green');
      const st=type==='city'?af.cities:type==='type'?af.types:af.fin;
      st.has(v)?(st.delete(v),p.classList.remove('on')):(st.add(v),p.classList.add('on'));
      if(!st.size)any.classList.add('on-green');applyFilters();
    });
    el.appendChild(p);
  });
}

function applyFilters(){
  const ds=g('searchInput').value.toLowerCase().trim();
  const ms=g('searchInputM').value.toLowerCase().trim();
  const srch=ds||ms;
  const df=parseFloat(g('deliveryFrom').value)||0,dt=parseFloat(g('deliveryTo').value)||9999;
  const dev=g('developerFilter').value,disc=+g('discountSlider').value||0;
  const fc=g('freeClub').checked,fp=g('freeParking').checked,hs=g('hideSold').checked;
  g('searchClear').classList.toggle('visible',ds.length>0);
  g('searchClearM').style.opacity=ms.length>0?'1':'0';

  filteredData=allData.filter(u=>{
    if(hs&&(u.is_sold||u.status===0))return false;
    if(af.cities.size&&!af.cities.has(u.city_name))return false;
    if(af.types.size&&!af.types.has(u.unit_type))return false;
    if(af.fin.size&&!af.fin.has(u.finishing_type))return false;
    if(af.beds!=='any'){const b=+af.beds;if(b===5){if(u.bedrooms<5)return false;}else if(u.bedrooms!==b)return false;}
    if(rs.pMin!==null&&u.total_price_egp<rs.pMin)return false;
    if(rs.pMax!==null&&u.total_price_egp>rs.pMax)return false;
    if(rs.aMin!==null&&u.built_up_area_sqm<rs.aMin)return false;
    if(rs.aMax!==null&&u.built_up_area_sqm>rs.aMax)return false;
    if(rs.sMin!==null&&u.price_per_sqm_egp<rs.sMin)return false;
    if(rs.sMax!==null&&u.price_per_sqm_egp>rs.sMax)return false;
    if(u.delivery_from_months<df||u.delivery_to_months>dt)return false;
    if(dev&&u.developer_name!==dev)return false;
    if(disc&&(u.cash_discount_percent||0)<disc)return false;
    if(fc&&u.club_fees?.toLowerCase()!=='free')return false;
    if(fp&&u.parking_fees?.toLowerCase()!=='free')return false;
    if(srch){const h=`${u.compound_name} ${u.developer_name} ${u.city_name} ${u.unit_type} ${u.finishing_type||''}`.toLowerCase();if(!h.includes(srch))return false;}
    return true;
  });
  filteredData.sort((a,b)=>{
    if(sortMode==='price_asc')return a.total_price_egp-b.total_price_egp;
    if(sortMode==='price_desc')return b.total_price_egp-a.total_price_egp;
    if(sortMode==='area_desc')return b.built_up_area_sqm-a.built_up_area_sqm;
    if(sortMode==='psm_asc')return a.price_per_sqm_egp-b.price_per_sqm_egp;
    if(sortMode==='discount_desc')return(b.cash_discount_percent||0)-(a.cash_discount_percent||0);
    if(sortMode==='delivery_asc')return a.delivery_from_months-b.delivery_from_months;
    return 0;
  });
  batchEnd=50;renderCards();updateStats();updateTags();updateBadge();
}

function cardHTML(u,i){return`<div class="unit-card" style="animation-delay:${(i%50)*.02}s">
  <div class="card-header"><div class="compound-name">${u.compound_name}</div><div class="type-badge">${u.unit_type}</div></div>
  <div class="card-meta">
    <div class="meta-chip">üìç <strong>${u.city_name}</strong></div>
    <div class="meta-chip">üèóÔ∏è <strong>${u.developer_name}</strong></div>
    <div class="meta-chip">üõèÔ∏è <strong>${u.bedrooms} BR</strong></div>
    <div class="meta-chip">üìê <strong>${u.built_up_area_sqm} m¬≤</strong></div>
    ${u.outdoor_area&&u.outdoor_area!=='0'?`<div class="meta-chip">üåø <strong>${u.outdoor_area}</strong></div>`:''}
    ${u.finishing_type?`<div class="meta-chip">üé® <strong>${u.finishing_type}</strong></div>`:''}
  </div>
  <div class="card-price">
    <div class="price-main"><small>Total Price</small>${fmtM(u.total_price_egp)} EGP</div>
    <div class="price-psm">${fmt(Math.round(u.price_per_sqm_egp))} EGP/m¬≤<small>per sqm</small></div>
  </div>
  <div class="card-footer">
    <div class="card-detail"><strong>${u.cash_price_from_egp?fmtM(u.cash_price_from_egp):'‚Äî'}</strong>Cash</div>
    <div class="card-detail"><strong>${u.cash_discount_percent||0}%</strong>Discount</div>
    <div class="card-detail"><strong>${u.delivery_from_months}‚Äì${u.delivery_to_months}mo</strong>Delivery</div>
    <div class="card-detail"><strong>${u.club_fees==='Free'?'‚úì Free':(u.club_fees||'‚Äî')}</strong>Club</div>
  </div>
${u.payment_plan?`<div style="margin-top:10px;border-top:1px solid var(--border);padding-top:8px;display:flex;align-items:center;gap:8px"><span>üí≥</span>${(()=>{const m=u.payment_plan.match(/([\d.]+)\s*%\s*down/i),mo=u.payment_plan.match(/(\d+)\s*month/i);if(!m||!mo)return`<span style="font-size:11px;color:var(--muted)">${u.payment_plan}</span>`;const y=parseInt(mo[1])/12,ys=Number.isInteger(y)?y:y.toFixed(1);return`<span style="padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;background:rgba(255,109,158,.15);border:1px solid rgba(255,109,158,.3);color:var(--accent2)">${parseFloat(m[1])}% down</span><span style="font-size:11px;color:var(--text);opacity:0.5;font-style:italic">over</span><span style="padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;background:rgba(109,255,203,.12);border:1px solid rgba(109,255,203,.25);color:var(--accent3)">${ys} ${y===1?'year':'years'}</span>`;})()}</div>`:''}
</div>`;}

function renderCards(){
  const grid=g('cardsGrid');g('resultNum').textContent=fmt(filteredData.length);
  if(!filteredData.length){
    grid.innerHTML=`<div class="empty-state"><h3>üîç No units found</h3><p>Try adjusting filters</p><button class="btn-reset" id="clrBtn" style="width:auto;margin-top:16px">Clear</button></div>`;
    g('clrBtn')?.addEventListener('click',resetFilters);return;
  }
  grid.innerHTML=filteredData.slice(0,50).map(cardHTML).join('');
  if(filteredData.length>50){
    const rem=filteredData.length-50;
    grid.innerHTML+=`<div class="empty-state" id="lmCard" style="background:var(--surface2);border-radius:16px;border:1px dashed var(--border)"><div style="font-size:24px">üì¶</div><h3 style="font-size:16px">${fmt(rem)} more</h3><button class="btn-reset" id="lmBtn" style="width:auto;margin-top:12px">Show More</button></div>`;
    g('lmBtn')?.addEventListener('click',loadMore);
  }
}
function loadMore(){
  const grid=g('cardsGrid');g('lmCard')?.remove();
  filteredData.slice(batchEnd,batchEnd+50).forEach((u,i)=>grid.insertAdjacentHTML('beforeend',cardHTML(u,i)));
  batchEnd+=50;
  if(batchEnd<filteredData.length){
    const rem=filteredData.length-batchEnd;
    grid.insertAdjacentHTML('beforeend',`<div class="empty-state" id="lmCard" style="background:var(--surface2);border-radius:16px;border:1px dashed var(--border)"><div style="font-size:24px">üì¶</div><h3 style="font-size:16px">${fmt(rem)} more</h3><button class="btn-reset" id="lmBtn" style="width:auto;margin-top:12px">Show More</button></div>`);
    g('lmBtn')?.addEventListener('click',loadMore);
  }
}
function updateStats(){
  const prices=filteredData.map(d=>d.total_price_egp).filter(Boolean);
  const avg=prices.length?prices.reduce((a,b)=>a+b,0)/prices.length:0;
  ['filteredCount','filteredCountM'].forEach(id=>g(id).textContent=fmt(filteredData.length));
  ['avgPrice','avgPriceM'].forEach(id=>g(id).textContent=avg?fmtM(avg):'‚Äî');
}
function updateTags(){
  const T=[];
  [...af.cities].forEach(c=>T.push({l:`üìç ${c}`,cl:()=>{af.cities.delete(c);applyFilters();}}));
  [...af.types].forEach(t=>T.push({l:`üè† ${t}`,cl:()=>{af.types.delete(t);applyFilters();}}));
  [...af.fin].forEach(f=>T.push({l:`üé® ${f}`,cl:()=>{af.fin.delete(f);applyFilters();}}));
  if(af.beds!=='any')T.push({l:`üõèÔ∏è ${af.beds}+ BR`,cl:()=>{af.beds='any';document.querySelectorAll('#bedroomsFilter .pill').forEach(p=>p.classList.remove('on'));document.querySelector('#bedroomsFilter .pill').classList.add('on-green');applyFilters();}});
  if(rs.pMin!==null||rs.pMax!==null)T.push({l:`üí∞ ${rs.pMin?fmtM(rs.pMin):'0'}‚Üí${rs.pMax?fmtM(rs.pMax):'‚àû'}`,cl:()=>{rs.pMin=null;rs.pMax=null;g('priceMinIn').value='';g('priceMaxIn').value='';g('priceMinHint').textContent='‚Äî';g('priceMaxHint').textContent='‚Äî';g('priceSMin').value=0;g('priceSMax').value=1000;syncFill('priceFill','priceSMin','priceSMax');clearChips('pricePresets');applyFilters();}});
  if(rs.aMin!==null||rs.aMax!==null)T.push({l:`üìê ${rs.aMin||0}‚Äì${rs.aMax||'‚àû'}m¬≤`,cl:()=>{rs.aMin=null;rs.aMax=null;g('areaMinIn').value='';g('areaMaxIn').value='';g('areaSMin').value=0;g('areaSMax').value=1000;syncFill('areaFill','areaSMin','areaSMax');applyFilters();}});
  if(rs.sMin!==null||rs.sMax!==null)T.push({l:`üìä ${rs.sMin?fmtM(rs.sMin):'0'}‚Äì${rs.sMax?fmtM(rs.sMax):'‚àû'}/m¬≤`,cl:()=>{rs.sMin=null;rs.sMax=null;g('psmMinIn').value='';g('psmMaxIn').value='';g('psmSMin').value=0;g('psmSMax').value=1000;syncFill('psmFill','psmSMin','psmSMax');applyFilters();}});
  if(+g('discountSlider').value>0)T.push({l:`üéØ ${g('discountSlider').value}%+`,cl:()=>{g('discountSlider').value=0;g('discountVal').textContent='0%';applyFilters();}});
  if(g('freeClub').checked)T.push({l:'üèä Free Club',cl:()=>{g('freeClub').checked=false;applyFilters();}});
  if(g('freeParking').checked)T.push({l:'üöó Free Parking',cl:()=>{g('freeParking').checked=false;applyFilters();}});
  if(g('developerFilter').value)T.push({l:`üèóÔ∏è ${g('developerFilter').value}`,cl:()=>{g('developerFilter').value='';applyFilters();}});
  const df=g('deliveryFrom').value,dt=g('deliveryTo').value;
  if(df||dt)T.push({l:`üìÖ ${df||0}‚Äì${dt||'‚àû'}mo`,cl:()=>{g('deliveryFrom').value='';g('deliveryTo').value='';clearDelChips();applyFilters();}});
  if(g('hideSold').checked)T.push({l:'üö´ Hiding Sold',cl:()=>{g('hideSold').checked=false;applyFilters();}});
  const cont=g('activeTags');
  cont.innerHTML=T.map((t,i)=>`<div class="tag">${t.l}<button data-i="${i}">√ó</button></div>`).join('');
  window._tc=T.map(t=>t.cl);
  cont.querySelectorAll('button[data-i]').forEach(b=>b.addEventListener('click',()=>window._tc[+b.dataset.i]()));
}
function resetFilters(){
  af.cities.clear();af.types.clear();af.fin.clear();af.beds='any';
  Object.assign(rs,{pMin:null,pMax:null,aMin:null,aMax:null,sMin:null,sMax:null});
  ['priceMinIn','priceMaxIn','areaMinIn','areaMaxIn','psmMinIn','psmMaxIn'].forEach(id=>g(id).value='');
  ['priceMinHint','priceMaxHint'].forEach(id=>{const e=g(id);if(e)e.textContent='‚Äî';});
  ['priceSMin','priceSMax','areaSMin','areaSMax','psmSMin','psmSMax'].forEach(id=>g(id).value=id.includes('SMin')?0:1000);
  syncFill('priceFill','priceSMin','priceSMax');syncFill('areaFill','areaSMin','areaSMax');syncFill('psmFill','psmSMin','psmSMax');
  document.querySelectorAll('.chip').forEach(c=>c.classList.remove('on'));
  g('discountSlider').value=0;g('discountVal').textContent='0%';
  g('deliveryFrom').value='';g('deliveryTo').value='';
  g('developerFilter').value='';
  g('freeClub').checked=false;g('freeParking').checked=false;g('hideSold').checked=false;
  g('searchInput').value='';g('searchInputM').value='';
  g('searchClear').classList.remove('visible');g('searchClearM').style.opacity='0';
  document.querySelectorAll('.pill').forEach(p=>p.classList.remove('on','on-green'));
  document.querySelectorAll('.pill-group .pill:first-child').forEach(p=>p.classList.add('on-green'));
  applyFilters();
}

document.addEventListener('DOMContentLoaded',()=>{
  // Sidebar open/close
  g('hamburgerBtn').addEventListener('click',openSidebar);
  g('closeBtn').addEventListener('click',closeSidebar);
  g('overlay').addEventListener('click',closeSidebar);
  // CRITICAL: stop clicks inside sidebar from reaching overlay
  g('sidebar').addEventListener('click',e=>e.stopPropagation());
  window.addEventListener('resize',()=>{if(window.innerWidth>768)closeSidebar();});

  g('resetBtn').addEventListener('click',resetFilters);

  // Search
  g('searchClear').addEventListener('click',()=>{g('searchInput').value='';g('searchClear').classList.remove('visible');applyFilters();});
  g('searchClearM').addEventListener('click',()=>{g('searchInputM').value='';g('searchClearM').style.opacity='0';applyFilters();});
  let st;
  g('searchInput').addEventListener('input',()=>{clearTimeout(st);st=setTimeout(applyFilters,200);});
  g('searchInputM').addEventListener('input',()=>{clearTimeout(st);st=setTimeout(applyFilters,200);});

  // Sliders
  g('priceSMin').addEventListener('input',onPriceSlide);g('priceSMax').addEventListener('input',onPriceSlide);
  g('priceMinIn').addEventListener('input',onPriceInput);g('priceMaxIn').addEventListener('input',onPriceInput);
  g('areaSMin').addEventListener('input',onAreaSlide);g('areaSMax').addEventListener('input',onAreaSlide);
  g('areaMinIn').addEventListener('input',onAreaInput);g('areaMaxIn').addEventListener('input',onAreaInput);
  g('psmSMin').addEventListener('input',onPsmSlide);g('psmSMax').addEventListener('input',onPsmSlide);
  g('psmMinIn').addEventListener('input',onPsmInput);g('psmMaxIn').addEventListener('input',onPsmInput);
  g('discountSlider').addEventListener('input',()=>{g('discountVal').textContent=g('discountSlider').value+'%';applyFilters();});

  // Toggles
  ['freeClub','freeParking','hideSold'].forEach(id=>g(id).addEventListener('change',applyFilters));
  g('developerFilter').addEventListener('change',applyFilters);
  g('deliveryFrom').addEventListener('input',()=>{clearDelChips();applyFilters();});
  g('deliveryTo').addEventListener('input',()=>{clearDelChips();applyFilters();});

  // Sort
  document.querySelectorAll('.sort-btn').forEach(b=>b.addEventListener('click',()=>{
    sortMode=b.dataset.sort;
    document.querySelectorAll('.sort-btn').forEach(x=>x.classList.remove('on'));
    b.classList.add('on');applyFilters();
  }));

  // Bedrooms
  document.querySelectorAll('#bedroomsFilter .pill').forEach(p=>p.addEventListener('click',()=>{
    document.querySelectorAll('#bedroomsFilter .pill').forEach(x=>x.classList.remove('on','on-green'));
    p.classList.add(p.dataset.bed==='any'?'on-green':'on');
    af.beds=p.dataset.bed;applyFilters();
  }));

  // Price presets
  document.querySelectorAll('#pricePresets .chip').forEach(c=>c.addEventListener('click',()=>setPricePreset(+c.dataset.pmin,+c.dataset.pmax,c.dataset.label)));
  // Area presets
  document.querySelectorAll('.area-chip').forEach(c=>c.addEventListener('click',()=>setAreaPreset(+c.dataset.min,+c.dataset.max)));
  // PSM presets
  document.querySelectorAll('.psm-chip').forEach(c=>c.addEventListener('click',()=>setPsmPreset(+c.dataset.min,+c.dataset.max)));
  // Delivery presets
  document.querySelectorAll('.del-chip').forEach(c=>c.addEventListener('click',()=>{
    g('deliveryFrom').value=c.dataset.from;g('deliveryTo').value=c.dataset.to;
    clearDelChips();c.classList.add('on');applyFilters();
  }));

  loadData();
});
</script>
</body>
</html>